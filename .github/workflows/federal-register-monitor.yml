name: Federal Register Monitor

on:
  schedule:
    - cron: '15 * * * *'
  workflow_dispatch:

jobs:
  check-federal-register:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check Federal Register for new documents
        run: |
          cat << 'EOF' > check-federal-register.js
          const fs = require('fs');
          const https = require('https');

          const SEARCH_TERMS = ['GENIUS Act', 'stablecoin', 'payment stablecoin'];
          const SEEN_FILE = 'seen-documents.json';

          function fetch(url) {
            return new Promise((resolve, reject) => {
              https.get(url, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  try {
                    resolve(JSON.parse(data));
                  } catch (e) {
                    reject(e);
                  }
                });
                res.on('error', reject);
              }).on('error', reject);
            });
          }

          async function searchFederalRegister() {
            const baseUrl = 'https://www.federalregister.gov/api/v1/documents.json';
            const allDocs = [];

            for (const term of SEARCH_TERMS) {
              const url = `${baseUrl}?conditions[term]=${encodeURIComponent(term)}&per_page=20&order=newest`;
              try {
                const response = await fetch(url);
                if (response.results) {
                  allDocs.push(...response.results);
                }
              } catch (e) {
                console.error(`Error searching for ${term}:`, e.message);
              }
            }

            const unique = {};
            for (const doc of allDocs) {
              if (doc.document_number) {
                unique[doc.document_number] = doc;
              }
            }
            return Object.values(unique);
          }

          async function main() {
            let seenData = { seenDocuments: [] };
            try {
              seenData = JSON.parse(fs.readFileSync(SEEN_FILE, 'utf8'));
              if (!seenData.seenDocuments) {
                seenData.seenDocuments = [];
              }
            } catch (e) {
              console.log('No seen-documents.json found, creating new one');
            }

            const seenNumbers = new Set(seenData.seenDocuments.map(d => d.document_number));

            const docs = await searchFederalRegister();
            console.log(`Found ${docs.length} total documents`);

            const newDocs = docs.filter(d => !seenNumbers.has(d.document_number));
            console.log(`Found ${newDocs.length} new documents`);

            if (newDocs.length > 0) {
              const today = new Date().toISOString().split('T')[0];
              for (const doc of newDocs) {
                seenData.seenDocuments.push({
                  document_number: doc.document_number,
                  title: doc.title,
                  type: doc.type,
                  agency: doc.agencies?.[0]?.name || 'Unknown',
                  publication_date: doc.publication_date,
                  first_seen: today
                });
              }
              seenData.lastChecked = new Date().toISOString();
              fs.writeFileSync(SEEN_FILE, JSON.stringify(seenData, null, 2));

              let html = fs.readFileSync('index.html', 'utf8');
              const todayFormatted = new Date().toLocaleDateString('en-US', {
                year: 'numeric', month: 'long', day: 'numeric', timeZone: 'America/New_York'
              });
              html = html.replace(
                /<span id="lastUpdated">.*?<\/span>/,
                `<span id="lastUpdated">${todayFormatted}</span>`
              );
              fs.writeFileSync('index.html', html);

              console.log('New documents found:');
              newDocs.forEach(d => console.log(`- ${d.title}`));
              fs.writeFileSync('has-updates.txt', 'true');
            } else {
              console.log('No new documents found');
            }
          }

          main().catch(e => { console.error('Error:', e); process.exit(1); });
          EOF

          node check-federal-register.js
          rm check-federal-register.js

      - name: Check for changes
        id: changes
        run: |
          if [ -f has-updates.txt ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            rm has-updates.txt
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push updates
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add seen-documents.json index.html
          git commit -m "Auto-update: New Federal Register documents"
          git push

      - name: Notify via Slack
        if: steps.changes.outputs.has_changes == 'true' && env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ðŸ”” GENIUS Act Tracker updated with new Federal Register documents!"}' \
            $SLACK_WEBHOOK_URL
